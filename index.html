<!DOCTYPE html>
<!--
    CoilChoice: A tool for understanding and desiging electromagnetic coils for MMF
    Copyright (C) 2015  Robert L. Read

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
    <head>
		<meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
		<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>A Model of Technical Debt</title>
        <meta name="description" content="A Model of Technical Debt" />
        <meta name="keywords" content="d3.js, area charts, zoom, pan, data, infographic, ajavscript, chart" />
        <link rel="shortcut icon" href="../favicon.ico"> 
        <link rel="stylesheet" type="text/css" href="css/style.css" />
		<link href='http://fonts.googleapis.com/css?family=Lato:300,700' rel='stylesheet' type='text/css' />
		<script type="text/javascript" src="js/modernizr.custom.79639.js"></script> 
		<!--[if lte IE 8]><style>.main{display:none;} .support-note .note-ie{display:block;}</style><![endif]-->	
		<script src="http://d3js.org/d3.v2.js"></script>
 <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
  <link rel="stylesheet" href="/resources/demos/style.css">
    </head>
    <body>
<div class="container">
  <section class="main">

 <div id="chart-container">
  <h1>A Model of Technical Debt</h1>
  <h3>Adjust % of Annual Investment Going to Paydown Technical Debt
  vs. Producing Value</h2>
<p id="target">
   30%
</p>
<div id="investments">
<div id="inv_scale">
<div id="highnumber">
100%
</div>
<div id="midnumber">
50%
</div>
<div id="lownumber">
0%
</div>
</div>
</div>

</section>

  
  

<section>

<div id="modelinfo">
<h2>A Basic Financial Model</h2>
<p>Initial Year: 2010</p>
<p>Number of Years: 10</p>
<p>Basic maintenace costs per year: $2000 (in thousands!)</p>
<p>Assumed Return-on-Investment in Government Bucks per Dollar input with no Technical Debt: 3.0</p>
<p>Sliders control each year investment between $0 and $4,000 (in thousands)<p>
</div>

</section>

<section>

<div id="thanks">
<h2>Thanks</h2>
<p>
  This model is implemented with D3 starting from code (<a href="http://tympanus.net/codrops/2012/08/29/multiple-area-charts-with-d3-js/">http://tympanus.net/codrops/2012/08/29/multiple-area-charts-with-d3-js/</a>)
  published by Tyler Craft on CoDrops.  
</p>
<p>
We thank Tyler Craft
  starting point and CoDrops for publishing with a license that
  allows us to reuse their work: <a href="http://tympanus.net/codrops/licensing/">http://tympanus.net/codrops/licensing/</a>
</p>
<p>
The design of this page was greatly improved by Michelle Hertzfeld.
</p>
</div>
</section>
</div>

</body>
  <script type="text/javascript">
    var margin = {top: 10, right: 40, bottom: 150, left: 60},
width = 940 - margin.left - margin.right,
height = 500 - margin.top - margin.bottom,
contextHeight = 50;
contextWidth = width * .5;

var svg = d3.select("#chart-container").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", (height + margin.top + margin.bottom));

    var initial_year = 2010;
    var num_years = 10;
    var maintenance_per_year = 2000.0;
    var target_percentage= 0.30;
    $( document ).ready(function() {
      $("#target").text("Target Technical Debt Percentage: " + 100*target_percentage + "%");
    });

    var investments = [];
    var td_investments = [];
    var ROI_Assumption = 3.0;
    var Technical_Debt_Interest= 0.1;
    var annual_investment = 4000.0;

    for(var i = 0; i < num_years; i++) {
//investments[i] = maintenance_per_year*(num_years - i)/num_years ;
        investments[i] = annual_investment;
	td_investments[i] = (100.0 *( target_percentage - 0.05));
    }

function ConstructSlider(key,initial)
{
  return '<span><span class="invtitle">'+(initial_year+key)+'</span><span class="invclass" id="invyear'+key+'">'+initial+'"</span></span>';
}

  function ConstructSlider2(key,initial)
{
  return '<span><span class="invtitle">'+(initial_year+key)+'</span><span class="invclass" id="invyeartd'+key+'">'+initial+'"</span></span>';
}

$(function() {

    // setup graphic sliders
    for(var i = 0; i < num_years; i++) {
//        $( "#investments" ).append( ConstructSlider(i,investments[i]) );
        $( "#investments" ).append( ConstructSlider2(i,td_investments[i]) );	
    }

var handle = null;
var ageInput = $("#ageInput");
var ageDisplay = $("#ageInput > div");

    var k = 0;
    for(var i = 0; i < num_years; i++) {
	var td_ele = $("#invyeartd"+i)
	    // read initial values from markup and remove that
	    var value = parseInt( $( td_ele ).text(), 10 );
	    $( td_ele ).empty().slider({
		value: value,
		range: "min",
		max: 100.0,
		animate: true,
		orientation: "vertical",
		change: function(event, ui) {
		    var str = event.target.id;
		    var i = parseInt(str.slice(9,str.length));
		    td_investments[i]= ui.value;

		    var obj = d3.select("#chart-container").select("svg").remove();
		    svg = d3.select("#chart-container").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", (height + margin.top + margin.bottom));
		    createChart(RobsModelOfTechnicalDebt());
		} 
	});
//        td_ele.css('background', 'rgb(200,100,100)');

/*	var ele = $("#invyear"+i)
	    // read initial values from markup and remove that
	    var value = parseInt( $( ele ).text(), 10 );
	    $( ele ).empty().slider({
		value: value,
		range: "min",
		max: 2000.0*2.0,
		animate: true,
		orientation: "vertical",
		change: function(event, ui) { 
		    var str = event.target.id;
		    var i = parseInt(str.slice(7,str.length));
		    investments[i] = ui.value;

		    var obj = d3.select("#chart-container").select("svg").remove();
		    svg = d3.select("#chart-container").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", (height + margin.top + margin.bottom));
		    createChart(RobsModelOfTechnicalDebt());
		} 
	});
*/
//        ele.css('background', 'rgb(100,200,100)');
    }
});

function RobsModelOfTechnicalDebt()
{
    var cur_td = 0.0;
    var roi = 1.0;


    var technical_debt_value_limit= 6000.0;
    var maintenance_per_year = target_percentage * annual_investment;
    var rdata = [];
    var current_output = 0.0;
    var i = 0;
    for(i = 0; i < num_years; i++) {
        var fraction_paydown = td_investments[i]/100.0;
        var fraction_value = (1.0 - fraction_paydown);
	var current_value = investments[i]*fraction_value;
	var current_paydown = maintenance_per_year + -investments[i]*fraction_paydown;
	roi = ROI_Assumption * ((technical_debt_value_limit - cur_td)/ (technical_debt_value_limit));

	rdata[i] = {
	    Year: i+initial_year,
	    'Value Output': roi*current_value,
	    'Technical Debt': cur_td,
	    ROI: roi,
	}
	cur_td = (cur_td + current_paydown);
        cur_td = cur_td * (1.0 + Technical_Debt_Interest);
        /* we choose not to have a model in which technical debt can
	    be negative. */
        cur_td = Math.max(0,cur_td);
    }

    return rdata;
}

function createChart(data){
    var countries = [];
    var charts = [];
    var maxDataPoint = 0;
    
    /* Loop through first row and get each country 
       and push it into an array to use later */
    for (var prop in data[0]) {
	if (data[0].hasOwnProperty(prop)) {
	    if (prop != 'Year') {
		countries.push(prop);
	    }
	}
    };

    var countriesCount = countries.length;

    var startYear = data[0]['Year'];
    var endYear = data[data.length - 1]['Year'];
    var chartHeight = height * (1 / countriesCount);

    /* Let's make sure these are all numbers, 
       we don't want javaScript thinking it's text 

       Let's also figure out the maximum data point
       We'll use this later to set the Y-Axis scale
    */
    data.forEach(function(d) {
	for (var prop in d) {
	if (d.hasOwnProperty(prop)) {
		d[prop] = parseFloat(d[prop]);
		if (d[prop] > maxDataPoint) {
		    maxDataPoint = d[prop];
		}
	    }
	}

	// D3 needs a date object, let's convert it just one time
	d.Year = new Date(d.Year,0,1);
    });

// Test: I don't really want the maxDataPoint to change in this application
    maxDataPoint = 6000.0;

    var mycolors = [ "rgb(34,135,141)", "rgb(188,57,58)",
    "rgb(137,153,56)" ];

    var maxScalePoints = [ 10000.0, 6000.0, 5.0 ];

    for(var i = 0; i < countriesCount; i++){
	charts.push(new Chart({
	    data: data.slice(),
	    id: i,
	    name: countries[i],
	    width: width,
	    height: height * (1 / countriesCount),
            color: mycolors[i],

// This is pretty ugly way to handle the ROI, as an exception...
// I've hacked this up so much this is really ugly.
	    maxDataPoint: maxScalePoints[i],
	    svg: svg,
	    margin: margin,
	    showBottomAxis: (i == countries.length - 1)
	}));

    }

    function onBrush(){
	/* this will return a date range to pass into the chart object */
	var b = brush.empty() ? contextXScale.domain() : brush.extent();
	for(var i = 0; i < countriesCount; i++){
	    charts[i].showOnly(b);
	}
    }
}

function Chart(options){
    this.chartData = options.data;
    this.width = options.width;
    this.height = options.height;
    this.maxDataPoint = options.maxDataPoint;
    this.svg = options.svg;
    this.id = options.id;
    this.name = options.name;
    this.margin = options.margin;
    this.showBottomAxis = options.showBottomAxis;

    var localName = this.name;

    /* XScale is time based */
    this.xScale = d3.time.scale()
	.range([0, this.width])
	.domain(d3.extent(this.chartData.map(function(d) { return d.Year; })));

    /* YScale is linear based on the maxData Point we found earlier */
    this.yScale = d3.scale.linear()
	.range([this.height,0])
	.domain([0,this.maxDataPoint]);
    var xS = this.xScale;
    var yS = this.yScale;

    /* 
       This is what creates the chart.
       There are a number of interpolation options. 
       'basis' smooths it the most, however, when working with a lot of data, this will slow it down 
    */
    this.area = d3.svg.area()
	.interpolate("basis")
	.x(function(d) { return xS(d.Year); })
	.y0(this.height)
	.y1(function(d) { return yS(d[localName]); });

    this.chartContainer = svg.append("g")
	.attr('class',this.name.toLowerCase())
		     
	.attr("transform", "translate(" + this.margin.left + "," + (this.margin.top + (this.height * this.id) + (30 * this.id)) + ")");

    /* We've created everything, let's actually add it to the page */
    this.chartContainer.append("path")
	.data([this.chartData])
	.attr("class", "chart")
	.attr("clip-path", "url(#clip-" + this.id + ")")
        .style("fill",function(d) { return options.color;})
        .style("fill-opacity",function(d) { return 0.7; })
	.attr("d", this.area);

    this.xAxisTop = d3.svg.axis().scale(this.xScale).orient("bottom");
    this.xAxisBottom = d3.svg.axis().scale(this.xScale).orient("top");
    /* We only want a top axis if it's the first country */
/*    if(this.id == 0){
	this.chartContainer.append("g")
	    .attr("class", "x axis top")
	    .attr("transform", "translate(0,0)")
	    .call(this.xAxisTop);
    }
*/

    /* Only want a bottom axis on the last country */
//    if(this.showBottomAxis){
/*
	this.chartContainer.append("g")
	    .attr("class", "x axis bottom")
	    .attr("transform", "translate(0," + this.height + ")")
	    .call(this.xAxisBottom);
*/
//    }  

    this.yAxis = d3.svg.axis().scale(this.yScale).orient("left").ticks(5);

    this.chartContainer.append("g")
	.attr("class", "y axis")
	.attr("transform", "translate(-15,0)")
        .style("fill",function(d) { return this.color;})
	.call(this.yAxis);

    this.chartContainer.append("text")
	.attr("class","country-title")
	.attr("transform", "translate(15,40)")
	.text(this.name);

}

Chart.prototype.showOnly = function(b){
    this.xScale.domain(b);
    this.chartContainer.select("path").data([this.chartData]).attr("d", this.area);
    this.chartContainer.select(".x.axis.top").call(this.xAxisTop);
    this.chartContainer.select(".x.axis.bottom").call(this.xAxisBottom);
}

createChart(RobsModelOfTechnicalDebt());

</script>

</html>
